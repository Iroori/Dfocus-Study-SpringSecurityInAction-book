# 01부 1장. 오늘날의 보안

생성자: 이루리
생성 일시: December 26, 2023 3:10 PM

## 오늘날의 보안

- 스프링 시큐리티의 개념과 이를 이용해 해결할 수 있는 문제
- 소프트웨어 애플리케이션에서 보안의 의미
- 소프트웨어 보안이 중요한 이유와 관심을 가져야하는 이유
- 애플리케이션 수준의 일반적인 취약성

### 스프링 시큐리티: 개념과 장점

- 스프링 시큐리티란
    - 인증과 접근 제어를 위해 세부적인 맞춤 구성이 가능한 프레임워크
    - 스프링 애플리케이션에 보안을 적용하는 과정을 크게 간소화할수 있는 프레임워크
    - 인증, 권한부여뿐 아니라 애플리케이션 수준의 보안을 적용 시 일반적인 공격에 대한 방어를 구현하는 세부적인 맞춤 구성 방법을 제공
    
- 장점
    - 스프링 시큐리티는 메시지를 가로채 애플리케이션이 주고받은 모든 종류의 데이터를 이용하기 전에 통신을 검증.
    - 상용구 코드를 작성하거나 앱 간에 같은 논리를 반복해서 작성할 필요가 없더록 사전 정의된 기능을 제공하기 때문에 모든 구성요소를 구성할 수 있으므로 유연성 또한 매우 높다.

### 소프트웨어 보안이란?

- 애플리케이션 수준 보안
    - 애플리케이션이 실행되는 환경과 애플리케이션이 처리하고 저장하는 데이터를 보호하기 위해 해야하는 모든 것을 나타냄.
    - 최상층에서 애플리케이션 수준을 보안을 구현하는 프레임워크 = 스프링 시큐리티
- 인증과 권한 부여
    - 인증
        - 애플리케이션이 사용자(사람  OR 다른 애플리케이션)를 식별하는 방법.
        - 사용자가 이용 권리가 있는지 확인
    - 권한 부여
        - 사용자를 식별하는 목적은 나중에 그들이 무엇을 하도록 허용해야 하는지 결정하기 위한 것
- 저장 데이터(Data at Rest)
    - 모든 데이터를 읽을 수 있는 형식이 아닌 개인키로 암호화한 데이터나 해시된 데이터로 저장.
    - 자격증명 및 개인 키와 같은 비밀도 저장데이터로 간주 → 비밀볼트에 저장
- 애플리케이션의 힙에 저장된 데이터
    - 저장된 데이터도 취약성의 원인이 될 수 있음.
    - 이유? 클래스 디자인에 따라 앱이 자격 증명, 개인 키 등의 민감한 데이터를 장시간 보관할 때가 있는데 힙 덤프 이용 권리가 있는 누군가가 이 사실을 악용할 수도 있음
    - 그래서 실행 중인 애플리케이션의 내부메모리도 관리

### 보안이 중요한 이유는 무엇인가?

- 사용자의 관점
- 객관적인 관점
- 수익성 손실을 초래하거나 애플리케이션에 대한 사용자의 신뢰 또한 애플리케이션의 성패를 가를 수 있기 때문

### 웹 애플리케이션의 일반적인 보안 취약성

- 인증 권한 부여의 취약성
    - 인증 (Authentication) : 애플리케이션이 이를 이용하려는 사람을 식별하는 프로세스
    - 권한부여(Authorization) : 인증된 호출자가 특정 기능과 데이터에 대한 이용 권리가 있는지 확인하는 프로세스
    - 인증 취약성이 있다는 것 : 사용자가 악의를 가지고 다른 사람의 기능이나 데이터에 접근할 수 있음.
- 세션고정
    - 공격자는 이미 생성된 세션 ID를 재이용해 유효한 사용자를 가장할 수 있음.
    - 웹 애플리케이션이 인증 프로세스 중 고유한 세션ID를 할당하지 않았기 때문에 기존 세션ID가 재사용될 가능성이 있을 때 발생
- XSS(교차 사이트 스크립팅)
    - 서버에 노출된 웹 서비스로 클라이언트 쪽 스크립트를 주입해 다른 사용자가 이를 실행하도록 하는 공격
    - 계정 가장(세션 고정과 결합) OR DDoS와 같은 분산 공격 참여 등의 결과가 발생.
- CSRF(사이트 간 요청 위조)
    - 특정 서버에서 작업을 호출하는 url 을 추출해 애플리케이션 외부에서 재사용할 수 있다고 가정.
    - 일반적으로 공격자는 csrf를 이용해 시스템의 데이터를 변경하는 동작을 실행.
- 주입(Injection)
    - 시스템에 특정 데이터를 주입하는 취약성 이용. (XSS 주입 취약성 중 하나라고 볼 수 있음)
    - 주입 공격 시스템에 피해를 가할 목적의 클라이언트 쪽 스크립트를 주입
    - ex] SQL 주입, Xpath주입, OS명령 주입, LDAP 주입 등
    - 주입은 피해 시스템의 데이터 변경, 삭제, 무단 이용을 유발하는 중요한 취약성 유형.
- 기밀 데이터 노출
    - 기밀 데이터 노출은 흔한 실수 중 하나
    - 중요 데이터는 볼트에 넣어야함. ?????????????
    - 기밀 데이터의 값들은 스프링 프로젝트의 [application.properties](http://application.properties) OR application.yml 파일 등의 구성 파일에서 설정하면 소스코드를 볼수 있는 모든 사람이 개인값에 접근할 수 있게됨. —>여기에 넣으라는건가?..
    - 민감한 데이터 노출 예시
        - 애플리케이션에서 콘솔 기록
        - 스플렁크나 일래스틱서치 같이 데이터베이스에 저장하는 로그 정보
    - 애플리케이션에 예외 발생시 반환 정보 주의
        - NullPointterException발생 시 응답 본문에 예외가 나오지 않도록 해야함.
        - 애플리케이션의 내부 구조가 공개되기 떄문.
- 메서드 접근 제어 부족
    - 애플리케이션 수준에서 한 계층에만 권한 부여를 적용하면 안됨.
- 알려진 취약성이 있는 종속성 이용
    - 스프링 시큐리티와 직접적인 연관은 X
    - 하지만 기능을 만들기 위해 이용하는 라이브러리나 프레잌워크 같은 종속성에 취약성이 있을 수 있기 때문에
    - 이용하는 종속성을 살펴보고 알려진 취약성 있는 버전은 제거

### 다양한 아키텍처에 적용된 보안

시스템의 디자인에 맞는 보안 관행 적용 방법

- 일체형 웹 애플리케이션 설계
    - CSRF 취약성
        - CSRF 방지 토큰 이용
        - 이 기능은 스프링 시큐리티 기본적으로 있음 CSRF 보호, 원점 CORS 검증도 기본적으로 활성화
        - 원치않을 경우 비활성화
        
        > CORS
        > 
        - **개념:** 웹 브라우저에서 동작하는 애플리케이션은 보안 상의 이유로 동일 출처 정책(Same-Origin Policy)에 따라 동일한 출처에서만 리소스를 요청할 수 있습니다. CORS는 이 정책을 우회하여 다른 출처에서 리소스를 요청할 수 있도록 하는 메커니즘입니다.
        - **취약성:** 만약 웹 애플리케이션이 출처 검사를 제대로 수행하지 않거나 잘못 구성된 경우, 공격자가 악의적인 웹사이트를 통해 희생자의 브라우저에서 자신의 도메인으로 리소스를 요청할 수 있습니다. 이는 특히 사용자의 브라우저에서 특정 도메인의 쿠키와 같은 인증 정보를 가져올 수 있는 보안 문제를 초래할 수 있습니다.
        
        > CSRF
        > 
        - **개념:** CSRF는 공격자가 희생자의 인증된 세션을 이용하여 특정 동작을 수행하도록 속이는 공격입니다. 희생자는 악의적인 웹사이트를 방문하거나 악의적인 이메일을 클릭하는 등의 행동을 했을 때, 공격자가 의도한 동작이 희생자의 권한으로 수행되게 됩니다.
        - **취약성:** CSRF 취약성이 있는 경우, 사용자가 웹 애플리케이션에 로그인되어 있는 상태에서 공격자의 조작된 페이지를 열어둔다면, 그 페이지에서 자동으로 사용자의 권한으로 특정 동작(예: 계정 설정 변경)을 수행할 수 있습니다.
- 백엔드/프론트엔드 분리를 위한 보안 설계
    - 이 경우 서버 쪽 세션을 줄이고 클라이언트 쪽 세션 대체하는 것이 좋음
    - 엔드포인트 인증에 HTTP Basic 이용 방법 → 가장 간단하지만 바람직하지 않음
        - 호출마다 자격증명 전송
        - 자격증명은 암호화되지 않음
        - 브라우저는 Base64 인코딩을 이용해 사용자 이름과 암호를 전송하므로 각 엔드포인트 호출의 헤더에 자격증명 노출
- OAuth 2 흐름 이해
    - 권한 부여 서버
        - 사용자에게 권한을 부여하고 사용자의 이용 권리 집합을 지정하는 토큰을 제공하는 것이 목적
    - 리소스 서버
        - 위의 기능을 구현하는 백엔드 부분을 리소스 서버라고 함
        - 호출할 수 있는 엔드포인트는 보호된 리소스
    - OAuth2 흐름
        1. 사용자가 애플리케이션의 기능에 접근한다. 애플리케이션은 백엔드의 리소스를 호출해야한다.
        2. 애플리케이션이 리소스를 호출하려면 먼저 액세스 토큰을 어덩야하므로 권한 부여 서버를 호출해 토큰을 얻는다. 이 요청을 위해 사용자 자격증명이나 때에 따라 갱신 토큰을 보낸다.
        3. 자격 증명이나 갱신 토큰이 올바르면 권한 부여 서버가 새로운 액세스 토큰을 클라이언트로 반환한다.
        4. 필요한리소스를 호출할 때 리소스 서버에 대한 요청 헤더는 엑세스 토큰을 이용한다.
    - 이점
        - 클라이언트는 사용자 자격증명을 저장할 필요 없이 액세스토큰과 최종적인 갱신 토큰만 저장하면됨
        - 애플리케이션은 사용자 자격 증명을 노출하지 않음
        - 누군가가 토큰을 가로채면 사용자 자격 증명을 무효로 할 필요 없이 토큰 실격시킬 수 있음
        - 토큰을 이용하면 제 삼자가 사용자를 가장하지 않고도 사용자 대신 리소스에 접근 가능. 물론 이 경우 공격자가 토큰을 훔칠 수 있지만 토큰은 일반적으로 수명이 제한됨으로 이 취약성 악용 기간도 제한.
    - 토큰 관리 방법 예시
        - 앱의 메모리에 토큰 유지
        - 데이터베이스에 토큰 유지
        - JWT(JSON 웹 토큰)을 통한 암호화 서명 사용
- API 키, 암호화 서명, IP검증을 이용해 요청 보안
    - 백엔드를 서비스 그룹으로 배포하거나 시스템 외부의 다른 백엔드를 이용하는 경우와 같이 구성 요소 간의 메시지를 어떤 방식으로든 검증하고 싶을 수 있음
    - 예시 사례
        - 요청 및 응답 헤더에 정적 키 이용
        - 암호화 서명으로 요청 및 응답 서명
        - IP 주소에 검증 적용

<aside>
💡 요약

</aside>

- 스프링 시큐리티는 스프링 애플리케이션을 보호하기 위한 가장 인기 있는 선택이며 다양한 스타일과 아키텍처에 적용할 수 있는 갖가지 대안 제공
- 시스템의 계층별로 보안을 적용해야하며 계층별로 다른 관행 이용
- 보안은 소프트웨어 프로젝트를 시작할 때 부터 고려해야 하는 공통 관심사
- 일반적으로 취약성을 예방하는 투자 비용보다 공격의 대가가 훨씬 큼
- 오픈 웹 애플리케이션 보안프로젝트(OWASP)는 취약성, 보안관련성 참고할 수 있는 훌륭한 장소
- 로그, 오류 메시지에 민감한 데이터를 노출하는 것은 애플리케이션에 취약성을 만드는 흔한 실수 !!!!!!!!!!!!!!